  <script>
    // *** สำคัญ: ตรวจสอบให้แน่ใจว่าได้ Deploy GAS เป็น 'Anyone' แล้ว ***
    const GAS_URL = "https://script.google.com/macros/s/AKfycbx4HOJfcsDr2fFLxKMhJhfyIPPv_dzf-4eFLqFI8uIpM5kkb7bhzJiSs_cN6WS5sLAn/exec";

    let animation, currentCategory = 'งานใบอนุญาตขับรถ', recognition, isListening = false;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    function handleManualInput() {
      const input = document.getElementById('userInput');
      const text = input.value.trim();
      if (text) { sendToGemini(text); input.value = ''; }
    }

    function handleKeyPress(e) { if (e.key === 'Enter') handleManualInput(); }

    if (SpeechRecognition) {
      recognition = new SpeechRecognition();
      recognition.lang = 'th-TH';
      recognition.onstart = () => {
        isListening = true;
        document.getElementById('micBtn').classList.add('recording');
        document.getElementById('statusText').innerText = "กำลังฟัง... พูดได้เลยค่ะ";
      };
      recognition.onresult = (event) => { sendToGemini(event.results[0][0].transcript); };
      recognition.onerror = () => { stopListening(); };
      recognition.onend = () => { stopListening(); };
    }

    function toggleListening() {
      if (isListening) { recognition.stop(); } 
      else { 
        window.speechSynthesis.speak(new SpeechSynthesisUtterance(""));
        try { recognition.start(); } catch(e) { alert("กรุณากดอนุญาตไมค์ที่แถบ URL ค่ะ"); }
      }
    }

    function stopListening() {
      isListening = false;
      document.getElementById('micBtn').classList.remove('recording');
      document.getElementById('statusText').innerText = "แตะไมค์เพื่อเริ่มพูด";
    }

    function setCategory(cat, btnId) {
      currentCategory = cat;
      document.querySelectorAll('.btn-cat').forEach(b => b.classList.remove('active'));
      document.getElementById(btnId).classList.add('active');
      document.getElementById('output').innerText = "เลือกหมวด: " + cat;
    }

    // แก้ไข: ใช้ Fetch พร้อมจัดการ Redirect ของ Google
    async function sendToGemini(query) {
      document.getElementById('output').innerText = "กำลังหาคำตอบสำหรับ: " + query;
      updateLottie('thinking');

      try {
        // เพิ่ม Parameter เพื่อระบุว่าเป็นคำถาม
        const fullUrl = `${GAS_URL}?query=${encodeURIComponent(query)}&category=${encodeURIComponent(currentCategory)}&action=ask`;
        const response = await fetch(fullUrl);
        const res = await response.json();
        
        document.getElementById('output').innerText = res.answer;
        if(res.url) playAni(res.url); 
        speak(res.answer);
      } catch (error) {
        console.error("Error:", error);
        document.getElementById('output').innerText = "ขออภัยค่ะ ระบบขัดข้องเล็กน้อย ลองใหม่อีกครั้งนะค";
      }
    }

    // แก้ไข: ดึง Lottie โดยตรงจาก Google Apps Script
    async function updateLottie(type) {
      try {
        const response = await fetch(`${GAS_URL}?action=getLottie&type=${type}`);
        const data = await response.json();
        if (data.url) {
          playAni(data.url);
        }
      } catch (e) { 
        console.log("Lottie fetch error, using fallback...");
        // ใส่ลิงก์สำรองเผื่อกรณีเชื่อมต่อ GAS ไม่ได้
        playAni("https://fonts.gstatic.com/s/i/short-term/release/googlesymbols/robot_2/default/24px.svg");
      }
    }

    function playAni(url) {
      if (!url) return;
      if (animation) animation.destroy();
      animation = lottie.loadAnimation({
        container: document.getElementById('lottie-view'),
        renderer: 'svg',
        loop: true,
        autoplay: true,
        path: url // GitHub จะโหลดไฟล์ .json ผ่าน URL นี้
      });
    }

    function speak(text) {
      window.speechSynthesis.cancel();
      const msg = new SpeechSynthesisUtterance(text.replace(/[*#-]/g, ""));
      msg.lang = 'th-TH';
      msg.onend = () => { updateLottie('idle'); };
      window.speechSynthesis.speak(msg);
    }

    // เริ่มต้นหน้าเว็บ
    window.onload = () => {
      // เรียกใช้ Lottie ทันที
      updateLottie('idle');
    };
  </script>
